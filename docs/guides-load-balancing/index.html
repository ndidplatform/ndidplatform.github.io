<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Load Balancing · NDID Platform</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="&lt;p&gt;Running a node (API main server) with load balancing config is preferable for nodes that have to process more than 15 requests/second. If you don&#x27;t need the ability to process more than 15 requests/second, it is recommended to run a main server in standalone mode for less complicated setup and latency.&lt;/p&gt;
"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Load Balancing · NDID Platform"/><meta property="og:type" content="website"/><meta property="og:url" content="https://ndidplatform.github.io/"/><meta property="og:description" content="&lt;p&gt;Running a node (API main server) with load balancing config is preferable for nodes that have to process more than 15 requests/second. If you don&#x27;t need the ability to process more than 15 requests/second, it is recommended to run a main server in standalone mode for less complicated setup and latency.&lt;/p&gt;
"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/undefined"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/railscasts.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="https://unpkg.com/mermaid@7.1.2/dist/mermaid.min.js"></script><script type="text/javascript" src="/js/custom.js"></script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><h2 class="headerTitle">NDID Platform</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/introduction" target="_self">Docs</a></li><li class=""><a href="/docs/api" target="_self">API</a></li><li class=""><a href="https://github.com/ndidplatform" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Guides</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">NDID Platform</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/introduction">Introduction</a></li><li class="navListItem"><a class="navItem" href="/docs/technical-overview">Technical Overview</a></li><li class="navListItem"><a class="navItem" href="/docs/components">Components</a></li><li class="navListItem"><a class="navItem" href="/docs/deployment">Deployment</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Getting Started</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/getting-started-setup">Setup</a></li><li class="navListItem"><a class="navItem" href="/docs/getting-started-ndid">NDID</a></li><li class="navListItem"><a class="navItem" href="/docs/getting-started-rp">RP</a></li><li class="navListItem"><a class="navItem" href="/docs/getting-started-idp">IdP</a></li><li class="navListItem"><a class="navItem" href="/docs/getting-started-as">AS</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Flows</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/flow-create-identity">Create Identity / Onboarding Flows</a></li><li class="navListItem"><a class="navItem" href="/docs/flow-add-accessor">Add Accessor Flows</a></li><li class="navListItem"><a class="navItem" href="/docs/flow-data-request">Data Request Flows</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Usage</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/usage-mode-2-data-request">Usage (Mode 2, Data request)</a></li><li class="navListItem"><a class="navItem" href="/docs/usage-more-usages">More Usages</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Guides</h3><ul class=""><li class="navListItem navListItemActive"><a class="navItem" href="/docs/guides-load-balancing">Load Balancing</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">Examples</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/examples-authen-flow">Example Authentication Flow</a></li><li class="navListItem"><a class="navItem" href="/docs/examples-data-request-flow">Example Data Request Flow</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">DEPRECATED</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/onboarding-story">Onboarding Story</a></li><li class="navListItem"><a class="navItem" href="/docs/public-storage">Public storage</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Load Balancing</h1></header><article><div><span><p>Running a node (API main server) with load balancing config is preferable for nodes that have to process more than 15 requests/second. If you don't need the ability to process more than 15 requests/second, it is recommended to run a main server in standalone mode for less complicated setup and latency.</p>
<p>There needs to be a master process to manage jobs for workers because requests must be process only once to avoid unintentional errors. Therefore, there is a limit to how much you can scale out.</p>
<h2><a class="anchor" aria-hidden="true" id="master-process"></a><a href="#master-process" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Master process</h2>
<p>There <strong>MUST</strong> be only 1 master process per node ID. This process handles messages and events, queue them, and distributes to worker processes. Master process does not have API HTTP server running.</p>
<p>To run API main server as a master process, set the following environment variables:</p>
<ul>
<li><code>MODE=master</code></li>
<li><code>MASTER_SERVER_PORT=&lt;GRPC_PORT_FOR_WORKER_TO_CONNECT&gt;</code></li>
</ul>
<p><strong>Example</strong></p>
<pre><code class="hljs css language-sh"><span class="hljs-built_in">cd</span> ./api/main-server

TENDERMINT_IP=127.0.0.1 \
TENDERMINT_PORT=27657 \
NODE_ID=idp1 \
PRIVATE_KEY_PATH=/path/to/keys/idp1.pem \
MASTER_PRIVATE_KEY_PATH=/path/to/keys/idp1_master.pem \
DB_PORT=6479 \
MQ_CONTACT_IP=127.0.0.1 \
MQ_BINDING_PORT=5655 \
MQ_SERVICE_SERVER_PORT=51051 \
MODE=master \
MASTER_SERVER_PORT=7001 \
node build/server.js
</code></pre>
<p>or with Docker</p>
<pre><code class="hljs css language-sh">docker run \
--link idp1_tm_1:tendermint \
--link idp1_redis:redis \
--link idp1_mq:mq \
--volume <span class="hljs-variable">$PWD</span>/keys:/keys \
--env <span class="hljs-string">"TENDERMINT_IP=tendermint"</span> \
--env <span class="hljs-string">"TENDERMINT_PORT=26657"</span> \
--env <span class="hljs-string">"DB_IP=redis"</span> \
--env <span class="hljs-string">"NODE_ID=idp1"</span> \
--env <span class="hljs-string">"PRIVATE_KEY_PATH=/keys/idp1.pem"</span> \
--env <span class="hljs-string">"MASTER_PRIVATE_KEY_PATH=/keys/idp1_master.pem"</span> \
--env <span class="hljs-string">"MQ_CONTACT_IP=&lt;YOUR_DOCKER_HOST_IP&gt;"</span> \
--env <span class="hljs-string">"MQ_SERVICE_SERVER_IP=mq"</span> \
--env <span class="hljs-string">"MQ_BINDING_PORT=5655"</span> \
--env <span class="hljs-string">"MQ_SERVICE_SERVER_PORT=51051"</span> \
--env <span class="hljs-string">"MODE=master"</span> \
--env <span class="hljs-string">"MASTER_SERVER_PORT=7001"</span> \
--name idp1_api_master \
ndidplatform/api
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="worker-process"></a><a href="#worker-process" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Worker process</h2>
<p>There can be as many worker processes as you see appropriate. API HTTP server will be run on worker processes. Client app should distribute API calls to each worker evenly. You can use a reverse proxy such as Nginx to help distribute API calls.</p>
<p>To run API main server as a worker process, set the following environment variables:</p>
<ul>
<li><code>MODE=worker</code></li>
<li><code>MASTER_SERVER_IP=&lt;MASTER_PROCESS_GRPC_IP&gt;</code></li>
<li><code>MASTER_SERVER_PORT=&lt;MASTER_PROCESS_GRPC_PORT&gt;</code></li>
</ul>
<p><strong>Example</strong></p>
<pre><code class="hljs css language-sh"><span class="hljs-built_in">cd</span> ./api/main-server

TENDERMINT_IP=127.0.0.1 \
TENDERMINT_PORT=27657 \
NODE_ID=idp1 \
PRIVATE_KEY_PATH=/path/to/keys/idp1.pem \
MASTER_PRIVATE_KEY_PATH=/path/to/keys/idp1_master.pem \
DB_PORT=6479 \
MQ_CONTACT_IP=127.0.0.1 \
MQ_BINDING_PORT=5655 \
MQ_SERVICE_SERVER_PORT=51051 \
SERVER_PORT=8180 \
MODE=worker \
MASTER_SERVER_IP=127.0.0.1 \
MASTER_SERVER_PORT=7001 \
node build/server.js
</code></pre>
<p>or with Docker</p>
<pre><code class="hljs css language-sh">docker run \
-p 8180:8180 \
--link idp1_tm_1:tendermint \
--link idp1_redis:redis \
--link idp1_mq:mq \
--link idp1_api_master:idp1_api_master \
--volume <span class="hljs-variable">$PWD</span>/keys:/keys \
--env <span class="hljs-string">"TENDERMINT_IP=tendermint"</span> \
--env <span class="hljs-string">"TENDERMINT_PORT=26657"</span> \
--env <span class="hljs-string">"DB_IP=redis"</span> \
--env <span class="hljs-string">"NODE_ID=idp1"</span> \
--env <span class="hljs-string">"PRIVATE_KEY_PATH=/keys/idp1.pem"</span> \
--env <span class="hljs-string">"MASTER_PRIVATE_KEY_PATH=/keys/idp1_master.pem"</span> \
--env <span class="hljs-string">"MQ_CONTACT_IP=&lt;YOUR_DOCKER_HOST_IP&gt;"</span> \
--env <span class="hljs-string">"MQ_SERVICE_SERVER_IP=mq"</span> \
--env <span class="hljs-string">"MQ_BINDING_PORT=5655"</span> \
--env <span class="hljs-string">"MQ_SERVICE_SERVER_PORT=51051"</span> \
--env <span class="hljs-string">"SERVER_PORT=8180"</span> \
--env <span class="hljs-string">"MODE=worker"</span> \
--env <span class="hljs-string">"MASTER_SERVER_IP=idp1_api_master"</span> \
--env <span class="hljs-string">"MASTER_SERVER_PORT=7001"</span> \
--name idp1_api_worker_1 \
ndidplatform/api
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="caveat"></a><a href="#caveat" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Caveat</h2>
<ul>
<li>There needs to be at least 1 master process and 1 worker process running for a node to function.</li>
<li>When shutting down server, worker processes should be stopped before master process to avoid dangling unfinished jobs.</li>
<li>Master process and all worker processes <strong>MUST</strong> use the same redis server.</li>
<li>There is a scaling limit nonetheless since master process is the only one that receives and distributes jobs to worker processes.</li>
<li>1 worker process can handle requests at approximately 15 requests/second.</li>
</ul>
</span></div></article></div><div class="docLastUpdate"><em>Last updated on 2019-7-1</em></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/usage-more-usages"><span class="arrow-prev">← </span><span>More Usages</span></a><a class="docs-next button" href="/docs/examples-authen-flow"><span>Example Authentication Flow</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#master-process">Master process</a></li><li><a href="#worker-process">Worker process</a></li><li><a href="#caveat">Caveat</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"></a><div><h5>Docs</h5><a href="/docs/introduction">Introduction</a><a href="/docs/getting-started-setup">Getting Started</a><a href="/docs/api">API Reference</a></div><div><h5>Community</h5><a href="http://www.ndid.co.th/" target="_blank" rel="noreferrer noopener">Official Site</a><a href="https://www.facebook.com/NationalDigitalID/" target="_blank" rel="noreferrer noopener">Facebook</a><a href="https://national-digital-id.slack.com/" target="_blank" rel="noreferrer noopener">Slack</a></div><div><h5>More</h5><a href="https://goo.gl/v4Cfpe" target="_blank" rel="noreferrer noopener">Whitepaper</a><a href="https://github.com/ndidplatform" target="_blank" rel="noreferrer noopener">GitHub</a></div></section><section class="copyright"></section></footer></div></body></html>